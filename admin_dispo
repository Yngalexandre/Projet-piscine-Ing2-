<?php
session_start();
// 0) Vérifier qu’on est bien connecté en tant qu’admin
if (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') {
    header('Location: ../connexion.html');
    exit;
}

// 1) Connexion à la BDD
$host     = 'localhost';
$user     = 'root';
$password = '';
$database = 'sportify';
$conn     = mysqli_connect($host, $user, $password, $database);
if (!$conn) {
    die("Erreur de connexion à la base de données");
}

// Initialisation
$selected_coach_id = $_POST['coach_id'] ?? null;
$message = '';

// 2) Sauvegarde des disponibilités
if (isset($_POST['action']) && $_POST['action'] === 'save_dispo' && $selected_coach_id) {
    // Supprimer les anciennes dispos
    $idc = (int)$selected_coach_id;
    mysqli_query($conn, "DELETE FROM disponibilites WHERE id_coach = $idc");

    // Insérer les nouveaux créneaux cochés
    if (!empty($_POST['dispo']) && is_array($_POST['dispo'])) {
        $stmt = mysqli_prepare(
            $conn,
            "INSERT INTO disponibilites (id_coach, jour_semaine, heure_debut, heure_fin, disponible)
             VALUES (?, ?, ?, ?, 1)"
        );
        foreach ($_POST['dispo'] as $jour => $heures) {
            $jour_safe = mysqli_real_escape_string($conn, $jour);
            foreach ($heures as $h) {
                $h = (int)$h;
                $debut = sprintf('%02d:00:00', $h);
                $fin   = sprintf('%02d:00:00', $h + 1);
                mysqli_stmt_bind_param($stmt, 'isss', $idc, $jour_safe, $debut, $fin);
                mysqli_stmt_execute($stmt);
            }
        }
        mysqli_stmt_close($stmt);
    }

    $message = "Disponibilités mises à jour avec succès.";
}

// 3) Récupération de la liste des coachs
$coachList = mysqli_query(
    $conn,
    "SELECT c.id, u.nom, u.prenom
     FROM coachs c
     JOIN utilisateurs u ON c.id_utilisateur = u.id
     ORDER BY u.nom, u.prenom"
);

// Pour l’affichage du calendrier : jours et plages horaires
$jours  = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
$heures = range(8, 19); // de 08:00 à 19:00 (créneaux d’une heure)
?>


<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Sportify – Calendrier Coach</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
</head>
<body>
  <div class="wrapper">

    <!-- HEADER -->
    <header class="header">
      <h1 class="header-title">
        <span class="red">Sportify :</span>
        <span class="blue">Consultation Sportive</span>
      </h1>
      <img src="../img/sportify_logo.png" alt="Logo Sportify" class="logo">
    </header>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-md">
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="main-navigation">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="admin_home.php">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_gestiondecompte.php">Gestion de Compte</a></li>
          <li class="nav-item"><a class="nav-link active" href="admin_dispo.php">Disponibilité</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_xml.php">Créer XML</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_votrecompte.php">Votre Compte</a></li>
        </ul>
      </div>
    </nav>
    <section class="section">
      <div class="container py-4">

        <h1>Définir les disponibilités d’un coach</h1>
        <!-- Affiche un message si on vient de sauvegarder -->
        <?php if ($message): ?>
          <div class="alert alert-success"><?= htmlspecialchars($message) ?></div>
        <?php endif; ?>

        <!-- Formulaire de sélection du coach -->
        <form method="post" class="form-inline mb-4">
          <label for="coach_id" class="mr-2">Choisir un coach :</label>
          <select name="coach_id" id="coach_id" class="form-control mr-2">
            <option value="">-- Sélectionnez --</option>
            <?php while ($c = mysqli_fetch_assoc($coachList)): ?>
              <option value="<?= $c['id'] ?>"
                <?= ($selected_coach_id == $c['id']) ? 'selected' : '' ?>>
                <?= htmlspecialchars($c['nom'].' '.$c['prenom']) ?>
              </option>
            <?php endwhile; ?>
          </select>
          <button name="action" value="select_coach" class="btn btn-primary">Afficher le calendrier</button>
        </form>

        <!-- Si un coach a été sélectionné, on affiche son calendrier -->
        <?php if ($selected_coach_id): 
          // Récupère les créneaux déjà cochés pour ce coach
          $qc  = (int)$selected_coach_id;
          $res = mysqli_query(
            $conn,
            "SELECT jour_semaine, HOUR(heure_debut) AS h
             FROM disponibilites
             WHERE id_coach = $qc AND disponible = 1"
          );
          $exist = [];
          while ($row = mysqli_fetch_assoc($res)) {
            $exist[$row['jour_semaine']][$row['h']] = true;
          }
        ?>
          <h2 class="mt-4">Calendrier de disponibilités</h2>
          <form method="post">
            <input type="hidden" name="coach_id" value="<?= $qc ?>">

            <!-- Wrapper Bootstrap pour rendre la table responsive -->
            <div class="table-responsive">
              <table class="table table-bordered calendrier">
                <thead class="thead-light">
                  <tr>
                    <th>Heure</th>
                    <?php foreach ($jours as $j): ?>
                      <th><?= $j ?></th>
                    <?php endforeach; ?>
                  </tr>
                </thead>
                <tbody>
                  <?php foreach ($heures as $h): ?>
                    <tr>
                      <td><?= sprintf('%02d:00 - %02d:00', $h, $h+1) ?></td>
                      <?php foreach ($jours as $j): ?>
                        <td>
                          <input
                            type="checkbox"
                            name="dispo[<?= $j ?>][]"
                            value="<?= $h ?>"
                            <?= isset($exist[$j][$h]) ? 'checked' : '' ?>
                          >
                        </td>
                      <?php endforeach; ?>
                    </tr>
                  <?php endforeach; ?>
                </tbody>
              </table>
            </div>
            <!-- Fin du wrapper responsive -->

            <button name="action" value="save_dispo" class="btn btn-success">Enregistrer</button>
          </form>
        <?php endif; ?>

      </div>
    </section>
    <!-- FIN de la SEULE ET UNIQUE SECTION -->

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-content">
        <div class="contact-info">
          <h4>Contactez-nous</h4>
          <p>
            Sportify<br>
            10 rue Sextius-Michel, 75015 Paris<br>
            <a href="mailto:info@sportify.fr">info@sportify.fr</a><br>
            +33 1 23 45 67 89
          </p>
        </div>
        <div class="map">
          <h4>Notre emplacement</h4>
          <iframe
            src="https://www.google.com/maps?q=10+rue+Sextius-Michel+75015+Paris&output=embed"
            width="100%" height="200" frameborder="0" style="border:0;"
            allowfullscreen>
          </iframe>
        </div>
      </div>
    </footer>
  </div>
</body>
</html>
