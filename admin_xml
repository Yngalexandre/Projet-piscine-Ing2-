<?php
session_start();
// 0) Vérifier qu’on est connecté en tant qu’admin
if (!isset($_SESSION['role']) || $_SESSION['role'] !== 'admin') {
    header('Location: ../connexion.html');
    exit;
}

// 1) Connexion à la BDD
$host = 'localhost';
$user = 'root';
$password = '';
$database = 'sportify';
$conn = mysqli_connect($host, $user, $password, $database);
if (!$conn) {
    die("Erreur de connexion à la base de données");
}

// 2) Prépare le dossier cv_xml
$xmlDir = __DIR__ . '/cv_xml/';
if (!is_dir($xmlDir)) {
    mkdir($xmlDir, 0755, true);
}

$message = '';
// 3) Si on a cliqué sur “Générer”
if (isset($_POST['generate']) && ctype_digit($_POST['coach_id'])) {
    $coachId = intval($_POST['coach_id']);

    // 4) Récupère **toutes** les infos en base
    $stmt = mysqli_prepare($conn,
      "SELECT c.id, u.nom, u.prenom, u.email, c.specialite, c.bureau, c.photo, c.video_url, c.email_chat, c.cv FROM coachs c JOIN utilisateurs u ON c.id_utilisateur = u.id WHERE c.id = ?");
    mysqli_stmt_bind_param($stmt, 'i', $coachId);
    mysqli_stmt_execute($stmt);
    mysqli_stmt_bind_result($stmt,$id,$nom,$prenom,$email,$specialite,$bureau,$photo,$videoUrl,$emailChat,$cvText);

    if (mysqli_stmt_fetch($stmt)) {
        // 5) Construit le DOM
        $dom = new DOMDocument('1.0', 'UTF-8');
        $dom->formatOutput = true;

        $root = $dom->createElement('coach');
        $root->setAttribute('id', $id);
        $dom->appendChild($root);

        // Sous-éléments
        $fields = [
          'nom'         => $nom,
          'prenom'      => $prenom,
          'email'       => $email,
          'specialite'  => $specialite,
          'bureau'      => $bureau,
          'photo'       => $photo,
          'video_url'   => $videoUrl,
          'email_chat'  => $emailChat
        ];
        foreach ($fields as $tag => $value) {
            $root->appendChild(
              $dom->createElement($tag, htmlspecialchars($value))
            );
        }

        // CV en CDATA
        $cvNode = $dom->createElement('cv');
        $cvNode->appendChild(
          $dom->createCDATASection($cvText)
        );
        $root->appendChild($cvNode);

        // 6) Sauvegarde
        $filename = $xmlDir . "cv_coach_{$id}.xml";
        $dom->save($filename);

        $message = "Fichier XML généré avec succès : <code>{$filename}</code>";
    } else {
        $message = "Coach introuvable en base.";
    }
    mysqli_stmt_close($stmt);
}

// 7) Prépare la liste déroulante
$res = mysqli_query($conn, "
    SELECT c.id, u.nom, u.prenom
      FROM coachs c
      JOIN utilisateurs u ON c.id_utilisateur = u.id
      ORDER BY u.nom, u.prenom
");
$coachs = mysqli_fetch_all($res, MYSQLI_ASSOC);
mysqli_close($conn);
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Exporter CV en XML – Admin Sportify</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
</head>
<body>
  <div class="wrapper">

    <!-- HEADER -->
    <header class="header">
      <h1 class="header-title">
        <span class="red">Sportify :</span>
        <span class="blue">Consultation Sportive</span>
      </h1>
      <img src="../img/sportify_logo.png" alt="Logo Sportify" class="logo">
    </header>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-md">
      <button class="navbar-toggler" type="button" data-toggle="collapse"
        data-target="#main-navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="main-navigation">
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"><a class="nav-link" href="admin_home.php">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_gestiondecompte.php">Gestion de Compte</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_dispo.php">Disponibilité</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_xml.php">Créer XML</a></li>
          <li class="nav-item"><a class="nav-link" href="admin_votrecompte.php">Votre Compte</a></li>
        </ul>
      </div>
    </nav>

    <section class="section">
      <h2>Générer un fichier XML pour le CV d’un coach</h2> <br>
      <?php if($message): ?>
        <div class="alert alert-info"><?= $message ?></div>
      <?php endif; ?>

      <form method="post">
        <div class="form-group">
          <label for="coach_id">Choisissez le coach :</label>
          <select id="coach_id" name="coach_id" class="form-control" required>
            <option value="" disabled selected>Sélectionnez</option>
            <?php foreach($coachs as $c): ?>
            <option value="<?= $c['id'] ?>">
              <?= htmlspecialchars($c['nom'] . ' ' . $c['prenom']) ?> (ID <?= $c['id'] ?>)
            </option>
            <?php endforeach; ?>
          </select>
        </div>
        <button type="submit" name="generate" class="btn btn-primary">
          Générer le XML
        </button>
      </form>
    </section>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-content">
        <div class="contact-info">
          <h4>Contactez-nous</h4>
          <p>
            Sportify<br>
            10 rue Sextius-Michel, 75015 Paris<br>
            <a href="mailto:info@sportify.fr">info@sportify.fr</a><br>
            +33 1 23 45 67 89
          </p>
        </div>
        <div class="map">
          <h4>Notre emplacement</h4>
          <iframe
            src="https://www.google.com/maps?q=10+rue+Sextius-Michel+75015+Paris&output=embed"
            width="100%" height="200" frameborder="0" style="border:0;"
            allowfullscreen>
          </iframe>
        </div>
      </div>
    </footer>

  </div>
</body>
</html>
