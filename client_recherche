<?php
session_start();

// Connexion à la base de données
$conn = mysqli_connect('localhost', 'root', '', 'sportify');
if (!$conn) {
    die("Erreur de connexion à la base de données");
}

// Traitement de la recherche
$action = $_POST['action'] ?? '';
$crit   = trim($_POST['crit'] ?? '');
$searchResults = [];
$searchError   = '';

if ($action === 'Rechercher') {
    $crit_safe = mysqli_real_escape_string($conn, $crit);
    if (ctype_digit($crit_safe)) {
        $query = "
            SELECT c.id, u.nom, u.prenom, c.specialite, c.bureau, c.photo, c.video_url, c.cv
            FROM coachs c
            JOIN utilisateurs u ON c.id_utilisateur = u.id
            WHERE c.id = $crit_safe
        ";
    } else {
        $query = "
            SELECT c.id, u.nom, u.prenom, c.specialite, c.bureau, c.photo, c.video_url, c.cv
            FROM coachs c
            JOIN utilisateurs u ON c.id_utilisateur = u.id
            WHERE u.nom LIKE '%$crit_safe%'
               OR u.prenom LIKE '%$crit_safe%'
               OR c.specialite LIKE '%$crit_safe%'
        ";
    }

    $res = mysqli_query($conn, $query);
    if ($res && mysqli_num_rows($res) > 0) {
        $searchResults = mysqli_fetch_all($res, MYSQLI_ASSOC);
    } else {
        $searchError = 'Aucun coach trouvé.';
    }
}

mysqli_close($conn);
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sportify – Recherche Coach</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
</head>
<body>
  <div class="wrapper">
    <!-- HEADER -->
    <header class="header">
    <h1 class="header-title">
      <span class="red">Sportify :</span>
      <span class="blue">Vos Rendez-vous</span>
    </h1>
    <img src="../img/sportify_logo.png" alt="Logo Sportify" class="logo">
  </header>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-md">
    <div class="collapse navbar-collapse" id="main-navigation">
      <ul class="navbar-nav mx-auto">
        <li class="nav-item"><a class="nav-link" href="client_home.php">Accueil</a></li>
        <li class="nav-item"><a class="nav-link" href="toutparcourirclient/client_toutparcourir.html">Tout Parcourir</a></li>
        <li class="nav-item"><a class="nav-link" href="client_recherche.php">Recherche</a></li>
        <li class="nav-item"><a class="nav-link" href="client_payant.php">Options payantes</a></li>
        <li class="nav-item"><a class="nav-link" href="client_rendezvous.php">Rendez-vous</a></li>
        <li class="nav-item"><a class="nav-link" href="client_votrecompte.php">Votre Compte</a></li>
      </ul>
    </div>
  </nav>

    <!-- SECTION : Recherche uniquement -->
    <section class="section">
      <form method="post" class="mb-4">
        <h2>Rechercher un coach</h2>
        <input type="text" name="crit" class="form-control d-inline-block w-auto" placeholder="ID, nom ou spécialité">
        <button type="submit" name="action" value="Rechercher" class="btn btn-primary ml-2">Rechercher</button>
      </form>

      <!-- Résultats -->
      <?php if($searchError): ?>
        <div class="alert alert-warning"><?= htmlspecialchars($searchError) ?></div>
      <?php elseif(count($searchResults)>0): ?>
        <table class="table table-bordered text-center">
          <thead class="thead-light">
            <tr>
              <th>ID</th>
              <th>Nom</th>
              <th>Prénom</th>
              <th>Spécialité</th>
              <th>Bureau</th>
              <th>Photo</th>
              <th>Vidéo</th>
              <th>CV</th>
            </tr>
          </thead>
          <tbody>
          <?php foreach($searchResults as $r): ?>
            <tr>
              <td><?= $r['id'] ?></td>
              <td><?= htmlspecialchars($r['nom']) ?></td>
              <td><?= htmlspecialchars($r['prenom']) ?></td>
              <td><?= htmlspecialchars($r['specialite']) ?></td>
              <td><?= htmlspecialchars($r['bureau']) ?></td>
              <td>
                <?php if ($r['photo']): ?>
                  <img src="../<?= htmlspecialchars($r['photo']) ?>" width="80" alt="Photo du coach">
                <?php endif; ?>
              </td>
              <td>
                <?php if ($r['video_url']): ?>
                  <video width="140" controls>
                    <source src="<?= htmlspecialchars($r['video_url']) ?>" type="video/mp4">
                    Votre navigateur ne supporte pas l’élément vidéo.
                  </video>
                <?php endif; ?>
              </td>
              <td>
                <?php if ($r['cv']): ?>
                  <a href="../<?= htmlspecialchars($r['cv']) ?>" target="_blank" class="btn btn-sm btn-outline-secondary">
                    Télécharger CV
                  </a>
                <?php endif; ?>
              </td>
            </tr>
          <?php endforeach; ?>
          </tbody>
        </table>
      <?php endif; ?>
    </section>

    <!-- FOOTER -->
    <footer class="footer mt-4">
      <div class="footer-content">
        <div class="contact-info">
          <h4>Contactez-nous</h4>
          <p>
            Sportify<br>
            10 rue Sextius-Michel, 75015 Paris<br>
            <a href="mailto:info@sportify.fr">info@sportify.fr</a><br>
            +33 1 23 45 67 89
          </p>
        </div>
        <div class="map">
          <h4>Notre emplacement</h4>
          <iframe
            src="https://www.google.com/maps?q=10+rue+Sextius-Michel+75015+Paris&output=embed"
            width="100%" height="200" frameborder="0" style="border:0;" allowfullscreen>
          </iframe>
        </div>
      </div>
    </footer>
  </div>
</body>
</html>
